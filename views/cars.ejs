<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Cars - LuxeDrive</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <%- include('includes/header.ejs') %>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="header-content">
                <h1>Premium Car Collection</h1>
                <p>Discover our extensive fleet of luxury, sports, and eco-friendly vehicles</p>
                <div class="breadcrumb">
                    <a href="/">Home</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>Cars</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Advanced Filters -->
    <section class="advanced-filters">
        <div class="container">
            <div class="filters-container">
                <div class="filter-section">
                    <h3>Filter by Category</h3>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="category" value="luxury" checked>
                            <span class="checkmark"></span>
                            Luxury
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="category" value="sports" checked>
                            <span class="checkmark"></span>
                            Sports
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="category" value="suv" checked>
                            <span class="checkmark"></span>
                            SUV
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="category" value="electric" checked>
                            <span class="checkmark"></span>
                            Electric
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="price-range">
                        <input type="range" id="priceMin" min="0" max="100000" value="0" class="range-slider">
                        <input type="range" id="priceMax" min="0" max="100000" value="100000" class="range-slider">
                        <div class="price-display">
                            <span>₹<span id="minPrice">0</span></span>
                            <span>₹<span id="maxPrice">100,000</span></span>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Transmission</h3>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="radio" name="transmission" value="all" checked>
                            <span class="radiomark"></span>
                            All
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="transmission" value="automatic">
                            <span class="radiomark"></span>
                            Automatic
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="transmission" value="manual">
                            <span class="radiomark"></span>
                            Manual
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Fuel Type</h3>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="fuel" value="petrol" checked>
                            <span class="checkmark"></span>
                            Petrol
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="fuel" value="diesel" checked>
                            <span class="checkmark"></span>
                            Diesel
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="fuel" value="electric" checked>
                            <span class="checkmark"></span>
                            Electric
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="fuel" value="hybrid" checked>
                            <span class="checkmark"></span>
                            Hybrid
                        </label>
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn-secondary" onclick="resetFilters()">Reset Filters</button>
                <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </section>

    <!-- Cars Grid -->
    <section class="cars-listing">
        <div class="container">
            <div class="listing-header">
                <div class="results-info">
                    <span id="resultsCount">24 cars found</span>
                </div>
                <div class="sort-options">
                    <select id="sortBy" class="sort-select">
                        <option value="featured">Featured</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="rating">Highest Rated</option>
                        <option value="newest">Newest First</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" data-view="list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="cars-grid" id="carsGrid">
                <% if (locals.cars && cars.length > 0) { %>
                    <% cars.forEach(car => { %>
                        <div class="car-card" 
                             data-category="<%= car.category %>"
                             data-price="<%= car.price %>"
                             data-transmission="<%= car.transmission %>"
                             data-fuel="<%= car.fuel %>">
                            <% if (car.badge) { %>
                                <div class="car-badge"><%= car.badge %></div>
                            <% } %>
                            <div class="car-image">
                                <img src="<%= car.image %>" alt="<%= car.name %>">
                            </div>
                            <div class="car-details">
                                <h3 class="car-name"><%= car.name %></h3>
                                <div class="car-rating">
                                    <% for(let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-star <%= i <= car.rating ? 'filled' : '' %>"></i>
                                    <% } %>
                                </div>
                                <div class="car-features">
                                    <span><i class="fas fa-users"></i> <%= car.seats %> Seats</span>
                                    <span><i class="fas fa-gas-pump"></i> <%= car.fuel %></span>
                                    <span><i class="fas fa-cog"></i> <%= car.transmission %></span>
                                </div>
                                <% if (car.features) { %>
                                    <div class="features-list">
                                        <% car.features.split(',').slice(0, 3).forEach(feature => { %>
                                            <span class="feature-tag"><%= feature.trim() %></span>
                                        <% }) %>
                                    </div>
                                <% } %>
                                <div class="car-price">
                                    <span class="price">₹<%= car.price %></span>
                                    <span class="duration">per day</span>
                                </div>
                              <button class="btn-primary book-now" data-car-id="<%= car.id %>" onclick="openBookingModalFor('<%= car.id %>')">Book Now</button>

                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="no-cars-found">
                        <i class="fas fa-car-side"></i>
                        <h3>No cars found</h3>
                        <p>Try adjusting your filters to see more results</p>
                    </div>
                <% } %>
            </div>

            <% if (locals.cars && cars.length > 0) { %>
                <div class="pagination">
                    <button class="page-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="page-btn active">1</button>
                    <% if (cars.length > 12) { %>
                        <button class="page-btn">2</button>
                    <% } %>
                    <% if (cars.length > 24) { %>
                        <button class="page-btn">3</button>
                    <% } %>
                    <button class="page-btn" <%= cars.length <= 12 ? 'disabled' : '' %>>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            <% } %>
        </div>
    </section>

    <!-- Comparison Modal -->
    <div class="modal" id="compareModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Compare Cars</h2>
                <button class="modal-close" onclick="closeModal('compareModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="compare-content">
                <div class="compare-grid" id="compareGrid">
                    <!-- Comparison content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupFilters();
            setupPriceRange();
            setupViewToggle();
        });

        function setupFilters() {
            const filterInputs = document.querySelectorAll('input[type="checkbox"], input[type="radio"]');
            filterInputs.forEach(input => {
                input.addEventListener('change', filterCars);
            });
        }

        function setupPriceRange() {
            const minSlider = document.getElementById('priceMin');
            const maxSlider = document.getElementById('priceMax');
            const minDisplay = document.getElementById('minPrice');
            const maxDisplay = document.getElementById('maxPrice');

            function updatePriceRange() {
                minDisplay.textContent = Number(minSlider.value).toLocaleString();
                maxDisplay.textContent = Number(maxSlider.value).toLocaleString();
                filterCars();
            }

            minSlider.addEventListener('input', updatePriceRange);
            maxSlider.addEventListener('input', updatePriceRange);
        }

        function filterCars() {
            const cars = document.querySelectorAll('.car-card');
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(input => input.value);
            const selectedFuels = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(input => input.value);
            const selectedTransmission = document.querySelector('input[name="transmission"]:checked').value;
            const minPrice = Number(document.getElementById('priceMin').value);
            const maxPrice = Number(document.getElementById('priceMax').value);

            cars.forEach(car => {
                const price = Number(car.dataset.price);
                const matches = (
                    (selectedCategories.includes(car.dataset.category)) &&
                    (selectedFuels.includes(car.dataset.fuel)) &&
                    (selectedTransmission === 'all' || car.dataset.transmission === selectedTransmission) &&
                    (price >= minPrice && price <= maxPrice)
                );
                car.style.display = matches ? 'block' : 'none';
            });

            updateResults();
        }

        function updateResults() {
            const visibleCars = document.querySelectorAll('.car-card[style="display: block"]').length;
            document.getElementById('resultsCount').textContent = `${visibleCars} cars found`;
        }

        function setupViewToggle() {
            const viewButtons = document.querySelectorAll('.view-btn');
            const carsGrid = document.getElementById('carsGrid');

            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    carsGrid.className = `cars-${button.dataset.view}`;
                });
            });
        }

        function resetFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = true);
            document.querySelector('input[name="transmission"][value="all"]').checked = true;
            document.getElementById('priceMin').value = 0;
            document.getElementById('priceMax').value = 100000;
            document.getElementById('minPrice').textContent = '0';
            document.getElementById('maxPrice').textContent = '100,000';
            filterCars();
        }

        function bookCar(carId) {
            // Redirect to booking page with car ID
            window.location.href = `/book/${carId}`;
        }
  if (typeof bookingData !== 'undefined' && bookingData) {
    try {
      const data = JSON.parse(bookingData)
      console.log("Booking data:", data)
      // You can use this data to filter available cars
    } catch (err) {
      console.warn('cars.ejs: bookingData is not valid JSON', err)
    }
  }


// carData will be injected from the server-side `cars` variable later in the page

function loadExtendedCarData() {
  // This will use the same carData from script.js but with extended functionality
  const extendedCarData = [
    ...carData,
    // Additional cars are already loaded in the main script.js
  ]

  renderCarsGrid(extendedCarData)
  updateResultsCount(extendedCarData.length)
}

function renderCarsGrid(cars) {
  const carsGrid = document.getElementById("carsGrid")
  if (!carsGrid) return

  carsGrid.innerHTML = cars
    .map(
      (car) => `
        <div class="car-card" data-category="${car.category}" data-price="${car.price}" data-transmission="${car.transmission.toLowerCase()}" data-fuel="${car.fuel.toLowerCase()}">
            <div class="car-image">
                <img src="${car.image}" alt="${car.name}" loading="lazy">
                <div class="car-badge">${car.badge}</div>
                <div class="car-actions">
                    <button class="action-btn" title="Add to Favorites" onclick="toggleFavorite('${car.id}')">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="action-btn" title="Compare" onclick="addToCompare('${car.id}')">
                        <i class="fas fa-balance-scale"></i>
                    </button>
                    <button class="action-btn" title="Quick View" onclick="quickView('${car.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="availability-indicator ${getAvailabilityStatus(car.id)}">
                    <i class="fas fa-circle"></i>
                    <span>${getAvailabilityText(car.id)}</span>
                </div>
            </div>
            <div class="car-info">
                <div class="car-header">
                    <h3>${car.name}</h3>
                    <div class="car-rating">
                        <div class="stars">
                            ${generateStars(car.rating)}
                        </div>
                        <span>(${car.rating})</span>
                    </div>
                </div>
                <div class="car-features">
                    <span><i class="fas fa-users"></i> ${car.seats} Seats</span>
                    <span><i class="fas fa-cog"></i> ${car.transmission}</span>
                    <span><i class="fas fa-${getFuelIcon(car.fuel)}"></i> ${car.fuel}</span>
                </div>
                <div class="car-specs">
                    ${car.features
                      .slice(0, 2)
                      .map((feature) => `<span class="spec-tag">${feature}</span>`)
                      .join("")}
                </div>
                <div class="car-price">
                    <span class="price">₹${formatIndianCurrency(car.price)}</span>
                    <span class="period">/day</span>
                    <div class="price-breakdown">
                        <small>Includes taxes & insurance</small>
                    </div>
                </div>
                <div class="car-actions-bottom">
                    <button class="btn-secondary btn-small" onclick="quickView('${car.id}')">
                        Quick View
                    </button>
                    <button class="btn-primary btn-small" onclick="bookNow('${car.id}')">
                        Book Now
                    </button>
                </div>
            </div>
        </div>
    `,
    )
    .join("")
}

function setupAdvancedFilters() {
  // Category filters
  const categoryFilters = document.querySelectorAll('input[name="category"]')
  categoryFilters.forEach((filter) => {
    filter.addEventListener("change", applyFilters)
  })

  // Transmission filters
  const transmissionFilters = document.querySelectorAll('input[name="transmission"]')
  transmissionFilters.forEach((filter) => {
    filter.addEventListener("change", applyFilters)
  })

  // Fuel type filters
  const fuelFilters = document.querySelectorAll('input[name="fuel"]')
  fuelFilters.forEach((filter) => {
    filter.addEventListener("change", applyFilters)
  })
}

function setupPriceRangeSliders() {
  const priceMin = document.getElementById("priceMin")
  const priceMax = document.getElementById("priceMax")
  const minPriceDisplay = document.getElementById("minPrice")
  const maxPriceDisplay = document.getElementById("maxPrice")

  if (priceMin && priceMax) {
    priceMin.addEventListener("input", function () {
      const minVal = Number.parseInt(this.value)
      const maxVal = Number.parseInt(priceMax.value)

      if (minVal >= maxVal) {
        this.value = maxVal - 1000
      }

      minPriceDisplay.textContent = formatIndianCurrency(Number.parseInt(this.value))
      applyFilters()
    })

    priceMax.addEventListener("input", function () {
      const minVal = Number.parseInt(priceMin.value)
      const maxVal = Number.parseInt(this.value)

      if (maxVal <= minVal) {
        this.value = minVal + 1000
      }

      maxPriceDisplay.textContent = formatIndianCurrency(Number.parseInt(this.value))
      applyFilters()
    })
  }
}

function setupSortingAndView() {
  // Sort functionality
  const sortSelect = document.getElementById("sortBy")
  if (sortSelect) {
    sortSelect.addEventListener("change", function () {
      sortCars(this.value)
    })
  }

  // View toggle
  const viewButtons = document.querySelectorAll(".view-btn")
  viewButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      const view = this.dataset.view
      toggleView(view)

      viewButtons.forEach((b) => b.classList.remove("active"))
      this.classList.add("active")
    })
  })
}

function applyFilters() {
  let filteredCars = [...carData]

  // Category filter
  const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(
    (input) => input.value,
  )

  if (selectedCategories.length > 0) {
    filteredCars = filteredCars.filter((car) => selectedCategories.includes(car.category))
  }

  // Price range filter
  const priceMin = document.getElementById("priceMin")
  const priceMax = document.getElementById("priceMax")

  if (priceMin && priceMax) {
    const minPrice = Number.parseInt(priceMin.value)
    const maxPrice = Number.parseInt(priceMax.value)
    filteredCars = filteredCars.filter((car) => car.price >= minPrice && car.price <= maxPrice)
  }

  // Transmission filter
  const selectedTransmission = document.querySelector('input[name="transmission"]:checked')?.value
  if (selectedTransmission && selectedTransmission !== "all") {
    filteredCars = filteredCars.filter((car) => car.transmission.toLowerCase() === selectedTransmission)
  }

  // Fuel type filter
  const selectedFuelTypes = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(
    (input) => input.value,
  )

  if (selectedFuelTypes.length > 0) {
    filteredCars = filteredCars.filter((car) => selectedFuelTypes.includes(car.fuel.toLowerCase()))
  }

  renderCarsGrid(filteredCars)
  updateResultsCount(filteredCars.length)
}

function resetFilters() {
  // Reset all checkboxes and radio buttons
  document.querySelectorAll('input[type="checkbox"]').forEach((input) => {
    input.checked = input.hasAttribute("checked")
  })

  document.querySelectorAll('input[type="radio"]').forEach((input) => {
    if (input.value === "all") {
      input.checked = true
    } else {
      input.checked = false
    }
  })

  // Reset price sliders
  const priceMin = document.getElementById("priceMin")
  const priceMax = document.getElementById("priceMax")

  if (priceMin && priceMax) {
    priceMin.value = 0
    priceMax.value = 100000
    document.getElementById("minPrice").textContent = "0"
    document.getElementById("maxPrice").textContent = "1,00,000"
  }

  // Re-render all cars
  renderCarsGrid(carData)
  updateResultsCount(carData.length)
}

function sortCars(sortBy) {
  const sortedCars = [...carData]

  switch (sortBy) {
    case "price-low":
      sortedCars.sort((a, b) => a.price - b.price)
      break
    case "price-high":
      sortedCars.sort((a, b) => b.price - a.price)
      break
    case "rating":
      sortedCars.sort((a, b) => b.rating - a.rating)
      break
    case "newest":
      // Assuming newer cars have higher IDs or you can add a date field
      sortedCars.reverse()
      break
    default:
      // Featured - keep original order
      break
  }

  renderCarsGrid(sortedCars)
}

function toggleView(view) {
  const carsGrid = document.getElementById("carsGrid")
  if (!carsGrid) return

  if (view === "list") {
    carsGrid.classList.add("list-view")
    carsGrid.classList.remove("grid-view")
  } else {
    carsGrid.classList.add("grid-view")
    carsGrid.classList.remove("list-view")
  }
}

function updateResultsCount(count) {
  const resultsCount = document.getElementById("resultsCount")
  if (resultsCount) {
    resultsCount.textContent = `${count} cars found`
  }
}

function getAvailabilityStatus(carId) {
  // Simulate availability status
  const statuses = ["available", "limited", "unavailable"]
  return statuses[Math.floor(Math.random() * statuses.length)]
}

function getAvailabilityText(carId) {
  const status = getAvailabilityStatus(carId)
  switch (status) {
    case "available":
      return "Available"
    case "limited":
      return "Limited"
    case "unavailable":
      return "Booked"
    default:
      return "Available"
  }
}

function quickView(carId) {
  const car = carData.find((c) => c.id === carId)
  if (!car) return

  // Create quick view modal content
  const modalContent = `
        <div class="quick-view-content">
            <div class="quick-view-image">
                <img src="${car.image}" alt="${car.name}">
            </div>
            <div class="quick-view-info">
                <h3>${car.name}</h3>
                <div class="car-rating">
                    <div class="stars">${generateStars(car.rating)}</div>
                    <span>(${car.rating})</span>
                </div>
                <div class="car-price">
                    <span class="price">₹${formatIndianCurrency(car.price)}</span>
                    <span class="period">/day</span>
                </div>
                <div class="car-features">
                    <span><i class="fas fa-users"></i> ${car.seats} Seats</span>
                    <span><i class="fas fa-cog"></i> ${car.transmission}</span>
                    <span><i class="fas fa-${getFuelIcon(car.fuel)}"></i> ${car.fuel}</span>
                </div>
                <div class="feature-list">
                    ${car.features.map((feature) => `<span class="feature-tag">${feature}</span>`).join("")}
                </div>
                <div class="quick-view-actions">
                    <button class="btn-secondary" onclick="closeModal('quickViewModal')">Close</button>
                    <button class="btn-primary" onclick="bookNow('${car.id}')">Book Now</button>
                </div>
            </div>
        </div>
    `

  // Create or update quick view modal
  let modal = document.getElementById("quickViewModal")
  if (!modal) {
    modal = document.createElement("div")
    modal.id = "quickViewModal"
    modal.className = "modal"
    modal.innerHTML = `
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Quick View</h2>
                    <button class="modal-close" onclick="closeModal('quickViewModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="quickViewContent"></div>
            </div>
        `
    document.body.appendChild(modal)
  }

  document.getElementById("quickViewContent").innerHTML = modalContent
  openModal("quickViewModal")
}

function bookNow(carId) {
  // Prefer opening the booking modal if present
  if (typeof openBookingModalFor === 'function') {
    try {
      openBookingModalFor(carId)
      return
    } catch (err) {
      console.warn('bookNow: failed to open modal, falling back', err)
    }
  }

  // If an external window.bookNow exists (loaded later), call it (avoid recursion)
  if (typeof window.bookNow === 'function' && window.bookNow !== bookNow) {
    try {
      window.bookNow(carId)
      return
    } catch (err) {
      console.warn('bookNow: external handler failed, falling back', err)
    }
  }

  // Fallback: save selected car and redirect to booking page
  const car = (typeof carData !== 'undefined') ? carData.find((c) => String(c.id) === String(carId)) : null
  if (car && typeof localStorage !== 'undefined') {
    try { localStorage.setItem('selectedCar', JSON.stringify(car)) } catch (e) { /* ignore */ }
  }
  window.location.href = '/booking'
}

// Comparison functionality
const comparisonList = []

function addToCompare(carId) {
  if (comparisonList.includes(carId)) {
    showNotification("Car already in comparison", "warning")
    return
  }

  if (comparisonList.length >= 3) {
    showNotification("Maximum 3 cars can be compared", "warning")
    return
  }

  comparisonList.push(carId)
  showNotification("Added to comparison", "success")
  updateComparisonButton()
}

function updateComparisonButton() {
  let compareBtn = document.getElementById("compareBtn")
  if (!compareBtn && comparisonList.length > 0) {
    compareBtn = document.createElement("button")
    compareBtn.id = "compareBtn"
    compareBtn.className = "floating-compare-btn"
    compareBtn.innerHTML = `
            <i class="fas fa-balance-scale"></i>
            Compare (${comparisonList.length})
        `
    compareBtn.onclick = () => openModal("compareModal")
    document.body.appendChild(compareBtn)
  }

  if (compareBtn) {
    if (comparisonList.length > 0) {
      compareBtn.innerHTML = `
                <i class="fas fa-balance-scale"></i>
                Compare (${comparisonList.length})
            `
      compareBtn.style.display = "flex"
    } else {
      compareBtn.style.display = "none"
    }
  }
}

// Initialize the cars page
window.CarsPage = {
  applyFilters,
  resetFilters,
  quickView,
  bookNow,
  addToCompare,
}

function generateStars(rating) {
  return "★★★★★".slice(0, Math.round(rating))
}

function getFuelIcon(fuel) {
  return fuel.toLowerCase() === "petrol" ? "gasoline" : "oil"
}

function formatIndianCurrency(amount) {
  return amount.toLocaleString("en-IN", { style: "currency", currency: "INR" }).replace("INR", "")
}

function openModal(modalId) {
  const modal = document.getElementById(modalId)
  if (modal) {
    modal.style.display = "block"
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId)
  if (modal) {
    modal.style.display = "none"
  }
}

function showNotification(message, type) {
  const notification = document.createElement("div")
  notification.className = `notification ${type}`
  notification.textContent = message
  document.body.appendChild(notification)

  setTimeout(() => {
    document.body.removeChild(notification)
  }, 3000)
}
     

  window.carDataJson = '<%- JSON.stringify(cars || []) %>';
  try {
    window.carData = JSON.parse(window.carDataJson);
  } catch (err) {
    console.warn('cars.ejs: failed to parse car data', err);
    window.carData = [];
  }
</script>

<script src="/js/cars.js"></script>
<!-- QR Code library (for rendering payment QR after booking) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


<!-- Booking Modal -->
<div id="bookingModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 500px; margin:auto;">
    <span class="close" onclick="closeBookingForm()">&times;</span>
    <h2>Book This Car</h2>

    <form id="bookingForm" onsubmit="submitBooking(event)">
      <input type="hidden" id="carId" name="carId">

      <label for="name">Full Name</label>
      <input type="text" id="name" name="name" required>

      <label for="email">Email</label>
      <input type="email" id="email" name="email" required>

      <label for="phone">Phone Number</label>
      <input type="tel" id="phone" name="phone" required>

      <label for="location">Pickup Location</label>
      <input type="text" id="location" name="location" required>

      <label for="startDate">Start Date</label>
      <input type="date" id="startDate" name="startDate" required>

      <label for="endDate">End Date</label>
      <input type="date" id="endDate" name="endDate" required>

      <button type="submit" class="btn-primary">Confirm Booking</button>
    </form>
  </div>
</div>

<script>
  function bookCar(carId) {
    document.getElementById('carId').value = carId;
    document.getElementById('bookingModal').style.display = 'block';
  }

  // New helper to avoid conflicts with other bookCar/bookNow functions
  function openBookingModalFor(carId) {
    const hidden = document.getElementById('carId')
    if (hidden) hidden.value = carId
    const modal = document.getElementById('bookingModal')
    if (modal) {
      // support both display toggle and CSS .active class for animations
      modal.style.display = 'block'
      modal.classList.add('active')
    }
  }

  function closeBookingForm() {
    const modal = document.getElementById('bookingModal')
    if (modal) {
      modal.style.display = 'none'
      modal.classList.remove('active')
    }
  }

  async function submitBooking(event) {
    event.preventDefault();

    const data = {
      carId: document.getElementById('carId').value,
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      location: document.getElementById('location').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value
    };

    const response = await fetch('/bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      // Booking persisted. Show a random payment QR code for the user to scan.
      const paymentCode = 'PAY-' + Math.random().toString(36).slice(2, 10).toUpperCase();

      // Close booking form
      closeBookingForm();

      // Render QR into payment modal (qrcode library is loaded separately)
      const qrContainer = document.getElementById('qrcode')
      if (qrContainer) qrContainer.innerHTML = ''
      try {
        if (typeof QRCode !== 'undefined') {
          new QRCode(qrContainer, { text: paymentCode, width: 220, height: 220 })
        } else if (qrContainer) {
          qrContainer.textContent = paymentCode
        }
      } catch (err) {
        if (qrContainer) qrContainer.textContent = paymentCode
      }

      const payModal = document.getElementById('paymentModal')
      const payCodeEl = document.getElementById('paymentCode')
      if (payCodeEl) payCodeEl.textContent = paymentCode
      if (payModal) {
        payModal.style.display = 'block'
        payModal.classList.add('active')
      }
    } else {
      alert('Failed to submit booking. Try again.');
    }
  }
</script>

<!-- Payment Modal (shows QR after successful booking) -->
<div id="paymentModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 420px; text-align:center; padding:2rem; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <button class="modal-close" onclick="closePaymentModal()">&times;</button>
    <h2>Complete Payment</h2>
    <p>Scan the QR code below to pay for your booking.</p>
  <div id="qrcode" style="margin:1rem auto; display:flex; align-items:center; justify-content:center; width:100%;"></div>
    <p>Your payment code: <strong id="paymentCode"></strong></p>
    <div style="margin-top:1rem;">
      <button class="btn-primary" onclick="closePaymentModal()">Done</button>
    </div>
  </div>
</div>

<script>
  function closePaymentModal() {
    const m = document.getElementById('paymentModal')
    if (m) {
      m.style.display = 'none'
      m.classList.remove('active')
    }
  }
</script>

<script>
  // Ensure book-now buttons open the modal no matter what
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.book-now').forEach(btn => {
      btn.addEventListener('click', function (e) {
        const id = this.dataset.carId || this.getAttribute('data-car-id')
        if (!id) return
        try {
          if (typeof openBookingModalFor === 'function') {
            openBookingModalFor(id)
          } else if (typeof window.carsRedirectBookNow === 'function') {
            window.carsRedirectBookNow(id)
          } else {
            // last resort
            window.location.href = '/booking'
          }
        } catch (err) {
          console.error('Error opening booking modal', err)
        }
      })
    })
  })
</script>



</body>
</html>
